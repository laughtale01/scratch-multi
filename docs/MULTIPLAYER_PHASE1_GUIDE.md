# マルチプレイヤー機能 Phase 1 - 実装ガイド

## 概要

Phase 1 では、複数のScratchクライアントが同時に1つのMinecraftサーバーに接続して操作できる基本的なマルチプレイヤー機能を実装しました。

### 実装済み機能

- ✅ 最大10クライアントの同時接続
- ✅ トークン認証（設定ファイル + 自動生成）
- ✅ 2つの役割（HOST / GUEST）
- ✅ 権限ベースのアクセス制御
- ✅ 先着順のコマンド処理
- ✅ リアルタイム操作通知（Minecraftチャット）
- ✅ 接続/切断イベントのブロードキャスト
- ✅ ハートビートによるヘルスチェック

---

## セットアップ

### 1. MODの設定ファイル

MODを初回起動すると、`config/minecraftedu/multiplayer.json` が自動生成されます。

#### デフォルト設定

```json
{
  "enabled": true,
  "maxClients": 10,
  "autoGenerateTokens": true,
  "clients": [
    {
      "name": "ホスト",
      "token": "ABC123",
      "role": "HOST"
    },
    {
      "name": "ゲスト1",
      "token": "XYZ789",
      "role": "GUEST"
    },
    {
      "name": "ゲスト2",
      "token": "DEF456",
      "role": "GUEST"
    },
    {
      "name": "ゲスト3",
      "token": "GHI012",
      "role": "GUEST"
    }
  ]
}
```

#### 設定項目

| 項目 | 説明 | デフォルト値 |
|------|------|------------|
| `enabled` | マルチプレイヤー機能の有効/無効 | `true` |
| `maxClients` | 最大同時接続数 | `10` |
| `autoGenerateTokens` | トークンの自動生成 | `true` |
| `clients` | 接続許可するクライアントのリスト | 4個のサンプル |

#### クライアント設定

| 項目 | 説明 | 例 |
|------|------|-----|
| `name` | クライアント名（表示用） | `"先生"`, `"生徒1"` |
| `token` | 認証トークン（6文字の英数字） | `"ABC123"` |
| `role` | 役割（`HOST` または `GUEST`） | `"HOST"` |

### 2. サーバー起動時の確認

MODを有効化してMinecraftサーバーを起動すると、以下のような情報がコンソールに表示されます：

```
==================================================
  MinecraftEdu - マルチプレイヤー設定
==================================================
ステータス: 有効
最大クライアント数: 10
自動トークン生成: 有効

接続情報:
--------------------------------------------------
  名前: ホスト          役割: HOST   トークン: ABC123
  名前: ゲスト1         役割: GUEST  トークン: XYZ789
  名前: ゲスト2         役割: GUEST  トークン: DEF456
  名前: ゲスト3         役割: GUEST  トークン: GHI012
==================================================

WebSocket server started on port 14711
```

---

## 役割と権限

### HOST（ホスト）

**すべての権限を持つ管理者**

| カテゴリ | 操作 | 権限 |
|---------|------|------|
| 基本操作 | チャット送信 | ✅ |
|  | ブロック配置・取得 | ✅ |
|  | 範囲ブロック配置 | ✅ |
| エンティティ | エンティティ召喚 | ✅ |
| プレイヤー | テレポート | ✅ |
|  | 位置・向き取得 | ✅ |
| ワールド | 天気変更 | ✅ |
|  | 時刻変更 | ✅ |
|  | ゲームモード変更 | ✅ |
| 管理操作 | エリアクリア | ✅ |
|  | エンティティ全削除 | ✅ |
|  | ゲームルール変更 | ✅ |

### GUEST（ゲスト）

**基本的な操作のみ可能**

| カテゴリ | 操作 | 権限 |
|---------|------|------|
| 基本操作 | チャット送信 | ✅ |
|  | ブロック配置・取得 | ✅ |
|  | 範囲ブロック配置 | ✅ |
| エンティティ | エンティティ召喚 | ✅ |
| プレイヤー | テレポート | ✅ |
|  | 位置・向き取得 | ✅ |
| ワールド | 天気変更 | ❌ |
|  | 時刻変更 | ❌ |
|  | ゲームモード変更 | ❌ |
| 管理操作 | エリアクリア | ❌ |
|  | エンティティ全削除 | ❌ |
|  | ゲームルール変更 | ❌ |

---

## Scratch側の接続方法

### 接続メッセージ形式

```json
{
  "version": "1.0",
  "messageId": "unique-id",
  "timestamp": 1234567890,
  "type": "connect",
  "payload": {
    "clientName": "生徒1",
    "token": "XYZ789"
  }
}
```

### 接続成功レスポンス

```json
{
  "version": "1.0",
  "messageId": "response-id",
  "timestamp": 1234567890,
  "sessionId": "session-abc-123",
  "type": "connect_response",
  "payload": {
    "success": true,
    "sessionId": "session-abc-123",
    "clientName": "生徒1",
    "role": "GUEST",
    "permissions": {
      "CHAT": "チャット送信",
      "PLACE_BLOCK": "ブロック配置",
      "GET_BLOCK": "ブロック取得",
      "FILL_BLOCKS": "範囲ブロック配置",
      "SUMMON_ENTITY": "エンティティ召喚",
      "TELEPORT": "テレポート",
      "GET_POSITION": "位置取得",
      "GET_FACING": "向き取得"
    },
    "serverInfo": {
      "version": "0.1.0",
      "minecraftVersion": "1.20.1",
      "maxClients": 10,
      "currentClients": 3
    }
  }
}
```

### 接続失敗レスポンス

```json
{
  "version": "1.0",
  "messageId": "response-id",
  "timestamp": 1234567890,
  "type": "error",
  "payload": {
    "errorCode": "CONNECTION_FAILED",
    "errorMessage": "無効なトークンです"
  }
}
```

---

## イベント通知

### クライアント接続イベント

他のクライアントが接続すると、既存の全クライアントに通知されます：

```json
{
  "version": "1.0",
  "messageId": "event-id",
  "timestamp": 1234567890,
  "type": "event",
  "payload": {
    "eventType": "client_connected",
    "data": {
      "sessionId": "session-xyz-456",
      "clientName": "生徒2",
      "role": "GUEST"
    }
  }
}
```

### 操作通知（Minecraftチャット）

クライアントが操作を行うと、Minecraftのチャットに通知が表示されます：

| 操作 | 通知例 |
|------|--------|
| ブロック配置 | `§e[生徒1] がブロックを配置しました (100, 64, 50)` |
| 範囲ブロック配置 | `§e[生徒1] が範囲ブロックを配置しました` |
| エンティティ召喚 | `§e[生徒1] が cow を召喚しました` |
| テレポート | `§e[生徒1] がテレポートしました` |
| 天気変更 | `§6[先生] が天気を clear に変更しました` |
| 時刻変更 | `§6[先生] が時刻を変更しました` |
| エリアクリア | `§6[先生] がエリアをクリアしました` |

**色分け**:
- `§e` (黄色) = 通常の操作
- `§6` (金色) = HOST限定の管理操作

---

## 権限エラー

GUESTが権限のない操作を試みると、エラーが返されます：

```json
{
  "version": "1.0",
  "messageId": "response-id",
  "timestamp": 1234567890,
  "type": "command_response",
  "payload": {
    "success": false,
    "action": "setWeather",
    "errorCode": "COMMAND_FAILED",
    "errorMessage": "権限不足: 天気変更 権限が必要です（役割: ゲスト）"
  }
}
```

---

## ハートビート

### クライアントからのハートビート

60秒ごとにハートビートを送信することを推奨します：

```json
{
  "version": "1.0",
  "type": "heartbeat"
}
```

### サーバーレスポンス

```json
{
  "version": "1.0",
  "messageId": "heartbeat-id",
  "timestamp": 1234567890,
  "sessionId": "session-abc-123",
  "type": "heartbeat",
  "payload": {
    "serverTime": 1234567890,
    "activeClients": 3
  }
}
```

60秒以上ハートビートがないクライアントは自動的に切断されます。

---

## トラブルシューティング

### 接続できない

1. **トークンが正しいか確認**
   - `config/minecraftedu/multiplayer.json` のトークンと一致しているか
   - 大文字小文字を区別します

2. **サーバーが満員**
   - 最大10クライアントまで（設定で変更可能）
   - 既に10人接続している場合は接続できません

3. **同じトークンが既に使用中**
   - 各トークンは1つのクライアントのみ使用可能
   - 別のトークンを使用してください

### 権限エラーが出る

1. **役割を確認**
   - GUEST役割では天気変更・時刻変更・エリアクリアなどは使用できません
   - HOST役割が必要な操作は、設定ファイルで役割を変更してください

2. **設定ファイルの編集**
   ```json
   {
     "name": "生徒1",
     "token": "XYZ789",
     "role": "GUEST"  // "HOST" に変更すればすべての権限が得られる
   }
   ```

### 通知が表示されない

1. **チャット設定を確認**
   - Minecraftのチャット設定で「システムメッセージ」が有効になっているか確認

2. **ログを確認**
   - サーバーコンソールに操作ログが出ているか確認

---

## 次のステップ（Phase 2以降）

Phase 1で実装しなかった機能：

- ❌ OBSERVER役割（見るだけの役割）
- ❌ 詳細な権限カスタマイズ
- ❌ Scratchイベントブロック（ハットブロック）
- ❌ 再接続機能
- ❌ 競合時の役割優先処理

これらは将来のバージョンで実装予定です。

---

## API仕様詳細

Phase 1で実装したWebSocket APIの完全な仕様については、`docs/MULTIPLAYER_DESIGN.md` を参照してください。

---

**作成日**: 2025-11-17
**対象バージョン**: MinecraftEdu MOD 0.2.0
**Minecraft**: 1.20.1
